---
layout: post
title: "Modelling data relationships with C# types"
description: "A C# example implementation of Ghosts of Departed Proofs."
date: 2025-02-03 7:24 UTC
tags: [Functional Programming]
---
{% include JB/setup %}

<div id="post">
    <p>
        <em>{{ page.description }}</em>
    </p>
    <p>
        This article continues where <a href="/2025/01/20/modelling-data-relationships-with-f-types">Modelling data relationships with F# types</a> left off. It ports the <a href="https://fsharp.org/">F#</a> example code to C#. If you don't read F# source code, you may instead want to read <a href="/2024/12/23/implementing-rod-cutting">Implementing rod-cutting</a> to get a sense of the problem being addressed.
    </p>
    <p>
        I'm going to assume that you've read enough of the previous articles to get a sense of the example, but in short, this article examines if it's possible to use the type system to model data relationships. Specifically, we have methods that operate on a collection and a number. The precondition for calling these methods is that the number is a valid (one-based) index into the collection.
    </p>
    <p>
        While you would typically implement such a precondition with a <a href="https://en.wikipedia.org/wiki/Guard_(computer_science)">Guard Clause</a> and communicate it via documentation, you can also use the <em>Ghosts of Departed Proofs</em> technique to instead leverage the type system. Please see <a href="/2025/01/20/modelling-data-relationships-with-f-types">the previous article for an overview</a>.
    </p>
    <p>
        That said, I'll repeat one point here: The purpose of these articles is to showcase a technique, using a simple example to make it, I hope, sufficiently clear what's going on. All this machinery is hardly warranted for an example as simple as this. All of this is a demonstration, not a recommendation.
    </p>
    <h3 id="24f5e14404424695aca0a2c7e049b0a5">
        Size proofs <a href="#24f5e14404424695aca0a2c7e049b0a5">#</a>
    </h3>
    <p>
        As in the previous article, we may start by defining what a 'size proof' looks like. In C#, it may <a href="/2015/08/03/idiomatic-or-idiosyncratic">idiomatically</a> be a class with an <code>internal</code> constructor.
    </p>
    <p>
        <pre><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">sealed</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">int</span>&nbsp;Value&nbsp;{&nbsp;<span style="color:blue;">get</span>;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">internal</span>&nbsp;<span style="color:#2b91af;">Size</span>(<span style="color:blue;">int</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">value</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">value</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;Also&nbsp;override&nbsp;ToString,&nbsp;Equals,&nbsp;and&nbsp;GetHashCode...</span>
}</pre>
    </p>
    <p>
        Since the constructor is <code>internal</code> it means that client code can't create <code><span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> instances, and thereby client code can't decide a concrete type for the phantom type <code>T</code>.
    </p>
    <h3 id="0f22adf378da484b8dc85e372f82a0d6">
        Issuing size proofs <a href="#0f22adf378da484b8dc85e372f82a0d6">#</a>
    </h3>
    <p>
        How may client code create <code><span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> objects? It may ask a <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> object to issue a proof:
    </p>
    <p>
        <pre><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">sealed</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">IReadOnlyCollection</span>&lt;<span style="color:blue;">int</span>&gt;&nbsp;Prices&nbsp;{&nbsp;<span style="color:blue;">get</span>;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">internal</span>&nbsp;<span style="color:#2b91af;">PriceList</span>(<span style="color:#2b91af;">IReadOnlyCollection</span>&lt;<span style="color:blue;">int</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Prices&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;?&nbsp;<span style="font-weight:bold;color:#74531f;">TryCreateSize</span>(<span style="color:blue;">int</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">candidate</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">if</span>&nbsp;(0&nbsp;&lt;&nbsp;<span style="font-weight:bold;color:#1f377f;">candidate</span>&nbsp;&amp;&amp;&nbsp;<span style="font-weight:bold;color:#1f377f;">candidate</span>&nbsp;&lt;=&nbsp;Prices.Count)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="font-weight:bold;color:#1f377f;">candidate</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">else</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="color:blue;">null</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;More&nbsp;members&nbsp;go&nbsp;here...</span></pre>
    </p>
    <p>
        If the requested <code>candidate</code> integer represents a valid (one-indexed) position in the <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> object, the return value is a <code><span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> object that contains the <code>candidate</code>. If, on the other hand, the <code>candidate</code> isn't in the valid range, no object is returned.
    </p>
    <p>
        Since both <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> and <code><span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> classes are immutable, once a 'size proof' has been issued, it remains valid. As I've previously argued, <a href="/2024/06/12/simpler-encapsulation-with-immutability">immutability makes encapsulation simpler</a>.
    </p>
    <p>
        This kind of API does, however, look like it's <a href="https://en.wikipedia.org/wiki/Turtles_all_the_way_down">turtles all the way down</a>. After all, the <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> constructor is also <code>internal</code>. Now the question becomes: How does client code create <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> objects?
    </p>
    <p>
        The short answer is that it doesn't. Instead, it'll be given an object by the library API. You'll see how that works later, but first, let's review what such an API enables us to express.
    </p>
    <h3 id="079355423c6d4a7d8daaeffc08661adb">
        Proof-based Cut API <a href="#079355423c6d4a7d8daaeffc08661adb">#</a>
    </h3>
    <p>
        As described in <a href="/2025/01/06/encapsulating-rod-cutting">Encapsulating rod-cutting</a>, returning a collection of 'cut' objects better communicates postconditions than returning a tuple of two arrays, as <a href="/2024/12/23/implementing-rod-cutting">the original algorithm suggested</a>. In other words, we're going to need a type for that.
    </p>
    <p>
        <pre><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">sealed</span>&nbsp;<span style="color:blue;">record</span>&nbsp;<span style="color:#2b91af;">Cut</span>&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="color:blue;">int</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">Revenue</span>,&nbsp;<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">Size</span>);</pre>
    </p>
    <p>
        In this case we can get by with a simple <a href="https://learn.microsoft.com/dotnet/csharp/language-reference/builtin-types/record">record type</a>. Since one of the properties is of the type <code><span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code>, client code can't create <code><span style="color:#2b91af;">Cut</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> instances, just like it can't create <code><span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> or <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> objects. This is what we want, because a <code><span style="color:#2b91af;">Cut</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> object encapsulates a proof that it's valid, related to the original collection of prices.
    </p>
    <p>
        We can now define the <code>Cut</code> method as an instance method on <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code>. Notice how all the <code>T</code> type arguments line up. As input, the <code>Cut</code> method only accepts <code><span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> proofs issued by a compatible price list. This is enforced at compile time, not at run time.
    </p>
    <p>
        <pre><span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">IReadOnlyCollection</span>&lt;<span style="color:#2b91af;">Cut</span>&lt;<span style="color:#2b91af;">T</span>&gt;&gt;&nbsp;<span style="font-weight:bold;color:#74531f;">Cut</span>(<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;=&nbsp;Prices.<span style="font-weight:bold;color:#74531f;">Prepend</span>(0).<span style="font-weight:bold;color:#74531f;">ToArray</span>();
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:blue;">int</span>[<span style="font-weight:bold;color:#1f377f;">n</span>.Value&nbsp;+&nbsp;1];
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:blue;">int</span>[<span style="font-weight:bold;color:#1f377f;">n</span>.Value&nbsp;+&nbsp;1];
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[0]&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">for</span>&nbsp;(<span style="color:blue;">int</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;=&nbsp;1;&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;&lt;=&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>.Value;&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>++)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">q</span>&nbsp;=&nbsp;<span style="color:blue;">int</span>.MinValue;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">for</span>&nbsp;(<span style="color:blue;">int</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;1;&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;&lt;=&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>;&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">candidate</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">if</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">q</span>&nbsp;&lt;&nbsp;<span style="font-weight:bold;color:#1f377f;">candidate</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">q</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">candidate</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">q</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:#2b91af;">Cut</span>&lt;<span style="color:#2b91af;">T</span>&gt;&gt;();
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">for</span>&nbsp;(<span style="color:blue;">int</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;1;&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;&lt;=&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>.Value;&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>++)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">revenue</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">i</span>];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">size</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>.<span style="font-weight:bold;color:#74531f;">Add</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">Cut</span>&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="font-weight:bold;color:#1f377f;">revenue</span>,&nbsp;<span style="font-weight:bold;color:#1f377f;">size</span>));
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>;
}</pre>
    </p>
    <p>
        For good measure, I'm showing the entire implementation, but you only need to pay attention to the method signature. The point is that <code>n</code> is constrained <em>by the type system</em> to be in a valid range.
    </p>
    <h3 id="ce55a32904434bd99c7f42d896fa7102">
        Proof-based Solve API <a href="#ce55a32904434bd99c7f42d896fa7102">#</a>
    </h3>
    <p>
        The same technique can be applied to the <code>Solve</code> method. Just align the <code>T</code>s.
    </p>
    <p>
        <pre><span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">IReadOnlyCollection</span>&lt;<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;&gt;&nbsp;<span style="font-weight:bold;color:#74531f;">Solve</span>(<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#74531f;">Cut</span>(<span style="font-weight:bold;color:#1f377f;">n</span>).<span style="font-weight:bold;color:#74531f;">ToArray</span>();
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">sizes</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;&gt;();
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">size</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">while</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">size</span>.Value&nbsp;&gt;&nbsp;0)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">sizes</span>.<span style="font-weight:bold;color:#74531f;">Add</span>(<span style="font-weight:bold;color:#1f377f;">cuts</span>[<span style="font-weight:bold;color:#1f377f;">size</span>.Value&nbsp;-&nbsp;1].Size);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">size</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="font-weight:bold;color:#1f377f;">size</span>.Value&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>[<span style="font-weight:bold;color:#1f377f;">size</span>.Value&nbsp;-&nbsp;1].Size.Value);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">sizes</span>;
}</pre>
    </p>
    <p>
        This is another instance method on <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code>, which is where <code>T</code> is defined.
    </p>
    <h3 id="57994590468c40fa87ba24f0d158720b">
        Proof-based revenue API <a href="#57994590468c40fa87ba24f0d158720b">#</a>
    </h3>
    <p>
        Finally, we may also implement a method to calculate the revenue from a given sequence of cuts.
    </p>
    <p>
        <pre><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">int</span>&nbsp;<span style="font-weight:bold;color:#74531f;">CalculateRevenue</span>(<span style="color:#2b91af;">IReadOnlyCollection</span>&lt;<span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">arr</span>&nbsp;=&nbsp;Prices.<span style="font-weight:bold;color:#74531f;">ToArray</span>();
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>.<span style="font-weight:bold;color:#74531f;">Sum</span>(<span style="font-weight:bold;color:#1f377f;">c</span>&nbsp;=&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">arr</span>[<span style="font-weight:bold;color:#1f377f;">c</span>.Value&nbsp;-&nbsp;1]);
}</pre>
    </p>
    <p>
        Not surprisingly, I hope, <code>CalculateRevenue</code> is another instance method on <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code>. The <code>cuts</code> will typically come from a call to <code>Solve</code>, but it's entirely possible for client code to create an ad-hoc collection of <code><span style="color:#2b91af;">Size</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> objects by repeatedly calling <code>TryCreateSize</code>.
    </p>
    <h3 id="97eba480d25e4ed8a5f7b8b0efb3a528">
        Running client code <a href="#97eba480d25e4ed8a5f7b8b0efb3a528">#</a>
    </h3>
    <p>
        How does client code use this API? It calls an <code>Accept</code> method with an implementation of this interface:
    </p>
    <p>
        <pre><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">interface</span>&nbsp;<span style="color:#2b91af;">IPriceListVisitor</span>&lt;<span style="color:#2b91af;">TResult</span>&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">TResult</span>&nbsp;<span style="font-weight:bold;color:#74531f;">Visit</span>&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList</span>);
}</pre>
    </p>
    <p>
        Why 'visitor'? This doesn't quite look like a <a href="https://en.wikipedia.org/wiki/Visitor_pattern">Visitor</a>, and yet, it still does.
    </p>
    <p>
        Imagine, for a moment, that we could enumerate all types that <code>T</code> could inhabit.
    </p>
    <p>
        <pre><span style="color:#2b91af;">TResult</span>&nbsp;<span style="font-weight:bold;color:#74531f;">Visit</span>(<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">Type1</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList</span>);
<span style="color:#2b91af;">TResult</span>&nbsp;<span style="font-weight:bold;color:#74531f;">Visit</span>(<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">Type2</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList</span>);
<span style="color:#2b91af;">TResult</span>&nbsp;<span style="font-weight:bold;color:#74531f;">Visit</span>(<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">Type3</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList</span>);
<span style="color:green;">//&nbsp;⋮</span>
<span style="color:#2b91af;">TResult</span>&nbsp;<span style="font-weight:bold;color:#74531f;">Visit</span>(<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">TypeN</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList</span>);</pre>
    </p>
    <p>
        Clearly we can't do that, since <code>T</code> is infinite, but <em>if</em> we could, the interface would look like a Visitor.
    </p>
    <p>
        I find the situation sufficiently similar to name the interface with the <em>Visitor</em> suffix. Now we only need a class with an <code>Accept</code> method.
    </p>
    <p>
        <pre><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">sealed</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">RodCutter</span>(<span style="color:#2b91af;">IReadOnlyCollection</span>&lt;<span style="color:blue;">int</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">TResult</span>&nbsp;<span style="font-weight:bold;color:#74531f;">Accept</span>&lt;<span style="color:#2b91af;">TResult</span>&gt;(<span style="color:#2b91af;">IPriceListVisitor</span>&lt;<span style="color:#2b91af;">TResult</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">visitor</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">visitor</span>.<span style="font-weight:bold;color:#74531f;">Visit</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:blue;">object</span>&gt;(<span style="font-weight:bold;color:#1f377f;">prices</span>));
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
    </p>
    <p>
        Client code may create a <code>RodCutter</code> object, as well as one or more classes that implement <code><span style="color:#2b91af;">IPriceListVisitor</span>&lt;<span style="color:#2b91af;">TResult</span>&gt;</code>, and in this way interact with the library API.
    </p>
    <p>
        Let's see some examples. We'll start with the original <a href="/ref/clrs">CLRS</a> example, written as an <a href="https://xunit.net/">xUnit.net</a> test.
    </p>
    <p>
        <pre>[<span style="color:#2b91af;">Fact</span>]
<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">void</span>&nbsp;<span style="font-weight:bold;color:#74531f;">ClrsExample</span>()
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">sut</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">RodCutter</span>([1,&nbsp;5,&nbsp;8,&nbsp;9,&nbsp;10,&nbsp;17,&nbsp;17,&nbsp;20,&nbsp;24,&nbsp;30]);
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">actual</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">sut</span>.<span style="font-weight:bold;color:#74531f;">Accept</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">CutRodVisitor</span>(10));
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">expected</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>[]&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;1,&nbsp;&nbsp;1),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;5,&nbsp;&nbsp;2),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;8,&nbsp;&nbsp;3),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(10,&nbsp;&nbsp;2),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(13,&nbsp;&nbsp;2),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(17,&nbsp;&nbsp;6),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(18,&nbsp;&nbsp;1),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(22,&nbsp;&nbsp;2),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(25,&nbsp;&nbsp;3),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(30,&nbsp;10)
&nbsp;&nbsp;&nbsp;&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Assert</span>.<span style="color:#74531f;">Equal</span>(<span style="font-weight:bold;color:#1f377f;">expected</span>,&nbsp;<span style="font-weight:bold;color:#1f377f;">actual</span>);
}</pre>
    </p>
    <p>
        <code>CutRodVisitor</code> is a nested class that implements the <code><span style="color:#2b91af;">IPriceListVisitor</span>&lt;<span style="color:#2b91af;">TResult</span>&gt;</code> interface:
    </p>
    <p>
        <pre><span style="color:blue;">private</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">CutRodVisitor</span>(<span style="color:blue;">int</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>)&nbsp;:
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">IPriceListVisitor</span>&lt;<span style="color:#2b91af;">IReadOnlyCollection</span>&lt;(<span style="color:blue;">int</span>,&nbsp;<span style="color:blue;">int</span>)&gt;&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">IReadOnlyCollection</span>&lt;(<span style="color:blue;">int</span>,&nbsp;<span style="color:blue;">int</span>)&gt;&nbsp;<span style="font-weight:bold;color:#74531f;">Visit</span>&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList</span>.<span style="font-weight:bold;color:#74531f;">TryCreateSize</span>(<span style="font-weight:bold;color:#1f377f;">i</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">if</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;<span style="color:blue;">is</span>&nbsp;<span style="color:blue;">null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;[];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">else</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList</span>.<span style="font-weight:bold;color:#74531f;">Cut</span>(<span style="font-weight:bold;color:#1f377f;">n</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>.<span style="font-weight:bold;color:#74531f;">Select</span>(<span style="font-weight:bold;color:#1f377f;">c</span>&nbsp;=&gt;&nbsp;(<span style="font-weight:bold;color:#1f377f;">c</span>.Revenue,&nbsp;<span style="font-weight:bold;color:#1f377f;">c</span>.Size.Value)).<span style="font-weight:bold;color:#74531f;">ToArray</span>();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
    </p>
    <p>
        The <code>CutRodVisitor</code> class returns a collection of tuples. Why doesn't it just return <code>cuts</code> directly?
    </p>
    <p>
        It can't, because it wouldn't type-check. Think about it for a moment. When you implement the interface, you need to pick a type for <code>TResult</code>. You can't, however, declare it to implement <code><span style="color:#2b91af;">IPriceListVisitor</span>&lt;<span style="color:#2b91af;">Cut</span>&lt;<span style="color:#2b91af;">T</span>&gt;&gt;</code> (where <code>T</code> would be the <code>T</code> from <code><span style="font-weight:bold;color:#74531f;">Visit</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code>), because at the class level, you don't know what <code>T</code> is. Neither does the compiler.
    </p>
    <p>
        Your <code><span style="font-weight:bold;color:#74531f;">Visit</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> implementation must work for <em>any</em> <code>T</code>.
    </p>
    <h3 id="39d9ed0b81044e5a8f7ac990cd457fad">
        Preventing misalignment <a href="#39d9ed0b81044e5a8f7ac990cd457fad">#</a>
    </h3>
    <p>
        Finally, here's a demonstration of how the phantom type prevents confusing or mixing up two (or more) different price lists. Consider this rather artificial example:
    </p>
    <p>
        <pre>[<span style="color:#2b91af;">Fact</span>]
<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">void</span>&nbsp;<span style="font-weight:bold;color:#74531f;">NestTwoSolutions</span>()
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">sut</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">RodCutter</span>([1,&nbsp;2,&nbsp;2]);
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">inner</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">RodCutter</span>([1]);
 
&nbsp;&nbsp;&nbsp;&nbsp;(<span style="color:blue;">int</span>,&nbsp;<span style="color:blue;">int</span>)?&nbsp;<span style="font-weight:bold;color:#1f377f;">actual</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">sut</span>.<span style="font-weight:bold;color:#74531f;">Accept</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">NestedRevenueVisitor</span>(<span style="font-weight:bold;color:#1f377f;">inner</span>));
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Assert</span>.<span style="color:#74531f;">Equal</span>((3,&nbsp;1),&nbsp;<span style="font-weight:bold;color:#1f377f;">actual</span>);
}</pre>
    </p>
    <p>
        This unit test creates two price arrays and calls <code>Accept</code> on one of them (the 'outer' one, you may say), while passing the <code>inner</code> one to the Visitor, which at first glance just looks like this:
    </p>
    <p>
        <pre><span style="color:blue;">private</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">NestedRevenueVisitor</span>(<span style="color:#2b91af;">RodCutter</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">inner</span>)&nbsp;:
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">IPriceListVisitor</span>&lt;(<span style="color:blue;">int</span>,&nbsp;<span style="color:blue;">int</span>)?&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;(<span style="color:blue;">int</span>,&nbsp;<span style="color:blue;">int</span>)?&nbsp;<span style="font-weight:bold;color:#74531f;">Visit</span>&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">inner</span>.<span style="font-weight:bold;color:#74531f;">Accept</span>(<span style="color:blue;">new</span>&nbsp;InnerRevenueVisitor&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="font-weight:bold;color:#1f377f;">priceList</span>));
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;Inner&nbsp;visitor&nbsp;goes&nbsp;here...</span>
}</pre>
    </p>
    <p>
        Notice that it only delegates to yet another Visitor, passing the 'outer' <code>priceList</code> as a constructor parameter to the next Visitor. The purpose of this is to bring two <code><span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;</code> objects in scope at the same time. This will enable us to examine what happens if we make a programming mistake.
    </p>
    <p>
        First, however, here's the proper, working implementation <em>without</em> mistakes:
    </p>
    <p>
        <pre><span style="color:blue;">private</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">InnerRevenueVisitor</span>&lt;<span style="color:#2b91af;">T</span>&gt;(<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList1</span>)&nbsp;:&nbsp;<span style="color:#2b91af;">IPriceListVisitor</span>&lt;(<span style="color:blue;">int</span>,&nbsp;<span style="color:blue;">int</span>)?&gt;
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;(<span style="color:blue;">int</span>,&nbsp;<span style="color:blue;">int</span>)?&nbsp;<span style="font-weight:bold;color:#74531f;">Visit</span>&lt;<span style="color:#2b91af;">T1</span>&gt;(<span style="color:#2b91af;">PriceList</span>&lt;<span style="color:#2b91af;">T1</span>&gt;&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList2</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n1</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList1</span>.<span style="font-weight:bold;color:#74531f;">TryCreateSize</span>(3);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">if</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n1</span>&nbsp;<span style="color:blue;">is</span>&nbsp;<span style="color:blue;">null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="color:blue;">null</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">else</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts1</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList1</span>.<span style="font-weight:bold;color:#74531f;">Solve</span>(<span style="font-weight:bold;color:#1f377f;">n1</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">revenue1</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList1</span>.<span style="font-weight:bold;color:#74531f;">CalculateRevenue</span>(<span style="font-weight:bold;color:#1f377f;">cuts1</span>);
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n2</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList2</span>.<span style="font-weight:bold;color:#74531f;">TryCreateSize</span>(1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">if</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n2</span>&nbsp;<span style="color:blue;">is</span>&nbsp;<span style="color:blue;">null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;<span style="color:blue;">null</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">else</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts2</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList2</span>.<span style="font-weight:bold;color:#74531f;">Solve</span>(<span style="font-weight:bold;color:#1f377f;">n2</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">revenue2</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">priceList2</span>.<span style="font-weight:bold;color:#74531f;">CalculateRevenue</span>(<span style="font-weight:bold;color:#1f377f;">cuts2</span>);
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#8f08c4;">return</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">revenue1</span>,&nbsp;<span style="font-weight:bold;color:#1f377f;">revenue2</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
    </p>
    <p>
        Notice how both <code>priceList1</code> and <code>priceList2</code> are now both in scope. So far, they're <em>not</em> mixed up, so the <code>Visit</code> implementation queries first one and then another for the optimal revenue. If all works well (which it does), it returns a tuple with the two revenues.
    </p>
    <p>
        What happens if I make a mistake? What if, for example, I write <code>priceList2.Solve(n1)</code>? It shouldn't be possible to use <code>n1</code>, which was issued by <code>pricelist1</code>, with <code>priceList2</code>. And indeed this isn't possible. With that mistake, the code doesn't compile. The compiler error is:
    </p>
    <blockquote>
        <p>
            Argument 1: cannot convert from 'Ploeh.Samples.RodCutting.Size&lt;T&gt;' to 'Ploeh.Samples.RodCutting.Size&lt;T1&gt;'
        </p>
    </blockquote>
    <p>
        When you look at the types, that makes sense. After all, there's no guarantee that <code>T</code> is equal to <code>T1</code>.
    </p>
    <p>
        You'll run into similar problems if you mix up the two 'contexts' in other ways. The code doesn't compile. Which is what you want.
    </p>
    <h3 id="1075e4f3ff6548cf8806ae9f419910b1">
        Conclusion <a href="#1075e4f3ff6548cf8806ae9f419910b1">#</a>
    </h3>
    <p>
        This article demonstrates how to use the <em>Ghosts of Departed Proofs</em> technique in C#. In some ways, I find that it comes across as more idiomatic in C# than in F#. I think this is because rank-2 polymorphism is only possible in F# when using its object-oriented features. Since F# is a functional-first programming language, it seems a little out of place there, whereas it looks more at home in C#.
    </p>
    <p>
        Perhaps I should have designed the F# code to make use of objects to the same degree as I've done here in C#.
    </p>
    <p>
        I think I actually like how the C# API turned out, although having to define and implement a class every time you need to supply a Visitor may feel a bit cumbersome. Even so, <a href="/2024/05/13/gratification">developer experience shouldn't be exclusively about saving a few keystrokes</a>. After all, <a href="/2018/09/17/typing-is-not-a-programming-bottleneck">typing isn't a bottleneck</a>.
    </p>
</div>