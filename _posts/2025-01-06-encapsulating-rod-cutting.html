---
layout: post
title: "Encapsulating rod-cutting"
description: "Focusing on usage over implementation."
date: 2025-01-06 10:45 UTC
tags: [F#, Functional Programming, Encapsulation]
---
{% include JB/setup %}

<div id="post">
    <p>
        <em>{{ page.description }}</em>
    </p>
    <p>
        This article is a part of a small article series about <a href="/2024/12/09/implementation-and-usage-mindsets">implementation and usage mindsets</a>. The hypothesis is that programmers who approach a problem with an implementation mindset may gravitate toward dynamically typed languages, whereas developers concerned with long-term maintenance and sustainability of a code base may be more inclined toward statically typed languages. This could be wrong, and is almost certainly too simplistic, but is still, I hope, worth thinking about. In the <a href="/2024/12/23/implementing-rod-cutting">previous article</a> you saw examples of an implementation-centric approach to problem-solving. In this article, I'll discuss what a usage-first perspective entails.
    </p>
    <p>
        A usage perspective indicates that you're first and foremost concerned with how useful a programming interface is. It's what you do when you take advantage of test-driven development (TDD). First, you write a test, which furnishes an example of what a usage scenario looks like. Only then do you figure out how to implement the desired API.
    </p>
    <p>
        In this article I didn't use TDD since I already had a particular implementation. Even so, while I didn't mention it in the previous article, I did add tests to verify that the code works as intended. In fact, because I wrote a few <a href="https://github.com/hedgehogqa/fsharp-hedgehog/">Hedgehog</a> properties, I have more than 10.000 test cases covering my implementation.
    </p>
    <p>
        I bring this up because TDD is only one way to focus on sustainability and <a href="/encapsulation-and-solid">encapsulation</a>. It's the most scientific methodology that I know of, but you can employ more ad-hoc, ex-post analysis processes. I'll do that here.
    </p>
    <h3 id="03ca7a9c8c8146b6b7f0c1275ae9abcc">
        Imperative origin <a href="#03ca7a9c8c8146b6b7f0c1275ae9abcc">#</a>
    </h3>
    <p>
        In the <a href="/2024/12/23/implementing-rod-cutting">previous article</a> you saw how the <code>Extended-Bottom-Up-Cut-Rod</code> pseudocode was translated to this <a href="https://fsharp.org/">F#</a> function:
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">cut</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;:&nbsp;_&nbsp;<span style="color:#2b91af;">array</span>)&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[0]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;0
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:blue;">mutable</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Int32</span>.MinValue
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;&lt;&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;<span style="color:blue;">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a08000;">q</span>&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="color:#a08000;">q</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>,&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span></pre>
    </p>
    <p>
        In case anyone is wondering: This is a bona-fide <a href="https://en.wikipedia.org/wiki/Pure_function">pure function</a>, even if the implementation is as imperative as can be. Given the same input, <code>cut</code> always returns the same output, and there are no side effects. We may wish to implement the function in a more <a href="/2015/08/03/idiomatic-or-idiosyncratic">idiomatic</a> way, but that's not our first concern. <em>My</em> first concern, at least, is to make sure that preconditions, invariants, and postconditions are properly communicated.
    </p>
    <p>
        The same goal applies to the <code>printSolution</code> action, also repeated here for your convenience.
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">printSolution</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;_,&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="color:#74531f;">cut</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:blue;">mutable</span>&nbsp;<span style="color:#a08000;">n</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">while</span>&nbsp;<span style="color:#a08000;">n</span>&nbsp;&gt;&nbsp;0&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#74531f;">printfn</span>&nbsp;<span style="color:#a31515;">&quot;</span><span style="color:#2b91af;">%i</span><span style="color:#a31515;">&quot;</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="color:#a08000;">n</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a08000;">n</span>&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="color:#a08000;">n</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="color:#a08000;">n</span>]</pre>
    </p>
    <p>
        Not that I'm not interested in more idiomatic implementations, but after all, they're <em>by definition</em> just implementation details, so first, I'll discuss encapsulation. Or, if you will, the usage perspective.
    </p>
    <h3 id="bb978144e56743639e83448c9b1d4f01">
        Names and types <a href="#bb978144e56743639e83448c9b1d4f01">#</a>
    </h3>
    <p>
        Based on the above two code snippets, we're given two artefacts: <code>cut</code> and <code>printSolution</code>. Since F# is a statically typed language, each operation also has a type.
    </p>
    <p>
        The type of <code>cut</code> is <code>int array -&gt; int -&gt; int array * int array</code>. If you're not super-comfortable with F# type signatures, this means that <code>cut</code> is a function that takes an integer array and an integer as inputs, and returns a tuple as output. The output tuple is a pair; that is, it contains two elements, and in this particular case, both elements have the same type: They are both integer arrays.
    </p>
    <p>
        Likewise, the type of <code>printSolution</code> is <code>int array -&gt; int -&gt; unit</code>, which again indicates that inputs must be an integer array and an integer. In this case the output is <code>unit</code>, which, in a sense, corresponds to <code>void</code> in many <a href="https://en.wikipedia.org/wiki/C_(programming_language)">C</a>-based languages.
    </p>
    <p>
        Both operations belong to a module called <code>Rod</code>, so their slightly longer, more formal names are <code>Rod.cut</code> and <code>Rod.printSolution</code>. Even so, <a href="/2020/11/23/good-names-are-skin-deep">good names are only skin-deep</a>, and I'm not even convinced that these are particularly good names. To be fair to myself, I adopted the names from the pseudocode from <a href="/ref/clrs">Introduction to Algorithms</a>. Had I been freer to name function and design APIs, I might have chosen different names. As it is, currently, there's no documentation, so the types are the only source of additional information.
    </p>
    <p>
        Can we infer proper usage from these types? Do they sufficiently well communicate preconditions, invariants, and postconditions? In other words, do the types satisfactorily indicate the <em>contract</em> of each operation? Do the functions exhibit good <a href="/encapsulation-and-solid">encapsulation</a>?
    </p>
    <p>
        We may start with the <code>cut</code> function. It takes as inputs an integer array and an integer. Are empty arrays allowed? Are all integers valid, or perhaps only natural numbers? What about zeroes? Are duplicates allowed? Does the array need to be sorted? Is there a relationship between the array and the integer? Can the single integer parameter be negative?
    </p>
    <p>
        And what about the return value? Are the two integer arrays related in any way? Can one be empty, but the other large? Can they both be empty? May negative numbers or zeroes be present?
    </p>
    <p>
        Similar questions apply to the <code>printSolution</code> action.
    </p>
    <p>
        <a href="/2022/08/22/can-types-replace-validation">Not all such questions can be answered by types</a>, but since we already have a type system at our disposal, we might as well use it to address those questions that are easily modelled.
    </p>
    <h3 id="2a9f41707fb9425da8078a7181f6e7d6">
        Encapsulating the relationship between price array and rod length <a href="#2a9f41707fb9425da8078a7181f6e7d6">#</a>
    </h3>
    <p>
        The first question I decided to answer was this: <em>Is there a relationship between the array and the integer?</em>
    </p>
    <p>
        The array, you may recall, is an array of prices. The integer is the length of the rod to cut up.
    </p>
    <p>
        A relationship clearly exists. The length of the rod must not exceed the length of the array. If it does, <code>cut</code> throws an <a href="https://learn.microsoft.com/dotnet/api/system.indexoutofrangeexception">IndexOutOfRangeException</a>. We can't calculate the optimal cuts if we lack price information.
    </p>
    <p>
        Likewise, we can already infer that the length must be a non-negative number.
    </p>
    <p>
        While we could choose to enforce this relationship with Guard Clauses, we may also consider a simpler API. Let the function infer the rod length from the array length.
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">cut</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;:&nbsp;_&nbsp;<span style="color:#2b91af;">array</span>)&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>.Length&nbsp;-&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[0]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;0
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:blue;">mutable</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Int32</span>.MinValue
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;&lt;&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;<span style="color:blue;">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a08000;">q</span>&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="color:#a08000;">q</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>,&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span></pre>
    </p>
    <p>
        You may argue that this API is more implicit, which <a href="https://peps.python.org/pep-0020/">we generally don't like</a>. The implication is that the rod length is determined by the array length. If you have a (one-indexed) price array of length <em>10</em>, then how do you calculate the optimal cuts for a rod of length <em>7?</em>
    </p>
    <p>
        By shortening the price array:
    </p>
    <p>
        <pre>&gt; let p = [|0; 1; 5; 8; 9; 10; 17; 17; 20; 24; 30|];;
val p: int array = [|0; 1; 5; 8; 9; 10; 17; 17; 20; 24; 30|]

&gt; cut (p |&gt; Array.take (7 + 1));;
val it: int array * int array =
  ([|0; 1; 5; 8; 10; 13; 17; 18|], [|0; 1; 2; 3; 2; 2; 6; 1|])</pre>
    </p>
    <p>
        This is clearly still sub-optimal. Notice, for example, how you need to add <code>1</code> to <code>7</code> in order to deal with the prefixed <code>0</code>. On the other hand, we're not done with the redesign, so it may be worth pursuing this course a little further.
    </p>
    <p>
        (To be honest, while this is the direction I ultimately choose, I'm not blind to the disadvantages of this implicit design. It makes it less clear to a client developer how to indicate a rod length. An alternative design would keep the price array and the rod length as two separate parameters, but then introduce a Guard Clause to check that the rod length doesn't exceed the length of the price array. Outside of <a href="https://en.wikipedia.org/wiki/Dependent_type">dependent types</a> I can't think of a way to model such a relationship between two values, and I admit to having no practical experience with dependent types. All this said, however, it's also possible that I'm missing an obvious design alternative. If you can think of a way to model this relationship in a non-<a href="https://www.hillelwayne.com/post/constructive/">predicative</a> way, please <a href="https://github.com/ploeh/ploeh.github.com?tab=readme-ov-file#comments">write a comment</a>.)
    </p>
    <p>
        I gave the <code>printSolution</code> the same treatment, after first having extracted a <code>solve</code> function in order to <a href="/2016/09/26/decoupling-decisions-from-effects">separate decisions from effects</a>.
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">solve</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;_,&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="color:#74531f;">cut</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">l</span>&nbsp;=&nbsp;<span style="color:#2b91af;">ResizeArray</span>&nbsp;()
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:blue;">mutable</span>&nbsp;<span style="color:#a08000;">n</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>.Length&nbsp;-&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">while</span>&nbsp;<span style="color:#a08000;">n</span>&nbsp;&gt;&nbsp;0&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">l</span>.<span style="font-weight:bold;color:#74531f;">Add</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="color:#a08000;">n</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a08000;">n</span>&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="color:#a08000;">n</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="color:#a08000;">n</span>]
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">l</span>&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">ofSeq</span>
 
<span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">printSolution</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;=&nbsp;<span style="color:#74531f;">solve</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">iter</span>&nbsp;(<span style="color:#74531f;">printfn</span>&nbsp;<span style="color:#a31515;">&quot;</span><span style="color:#2b91af;">%i</span><span style="color:#a31515;">&quot;</span>)</pre>
    </p>
    <p>
        The <em>implementation</em> of the <code>solve</code> function is still imperative, but if you view it as a black box, it's <a href="https://en.wikipedia.org/wiki/Referential_transparency">referentially transparent</a>. We'll get back to the implementation later.
    </p>
    <h3 id="01d4ef562a9d4552870ef093ae907f45">
        Returning a list of cuts <a href="#01d4ef562a9d4552870ef093ae907f45">#</a>
    </h3>
    <p>
        Let's return to all the questions I enumerated above, particularly the questions about the return value. Are the two integer arrays related?
    </p>
    <p>
        Indeed they are! In fact, they have the same length.
    </p>
    <p>
        As explained in the <a href="/2024/12/23/implementing-rod-cutting">previous article</a>, in the original pseudocode, the <code>r</code> array is supposed to be zero-indexed, but non-empty and containing <code>0</code> as the first element. The <code>s</code> array is supposed to be one-indexed, and be exactly one element shorter than the <code>r</code> array. In practice, in all three implementations shown in that article, I made both arrays zero-indexed, non-empty, and of the exact same length. This is also true for the F# implementation.
    </p>
    <p>
        We can communicate this relationship much better to client developers by changing the return type of the <code>cut</code> function. Currently, the return type is <code>int array * int array</code>, indicating a pair of arrays. Instead, we can change the return type to an array of pairs, thereby indicating that the values are related two-and-two.
    </p>
    <p>
        That would be a decent change, but we can further improve the API. A pair of integers are still implicit, because it isn't clear which integer represents the revenue and which one represents the size. Instead, we introduce a custom type with clear labels:
    </p>
    <p>
        <pre><span style="color:blue;">type</span>&nbsp;<span style="color:#2b91af;">Cut</span>&nbsp;=&nbsp;{&nbsp;Revenue&nbsp;:&nbsp;<span style="color:#2b91af;">int</span>;&nbsp;Size&nbsp;:&nbsp;<span style="color:#2b91af;">int</span>&nbsp;}</pre>
    </p>
    <p>
        Then we change the <code>cut</code> function to return a collection of <code>Cut</code> values:
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">cut</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;:&nbsp;_&nbsp;<span style="color:#2b91af;">array</span>)&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>.Length&nbsp;-&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[0]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;0
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:blue;">mutable</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Int32</span>.MinValue
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;&lt;&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;<span style="color:blue;">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a08000;">q</span>&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="color:#a08000;">q</span>
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">result</span>&nbsp;=&nbsp;<span style="color:#2b91af;">ResizeArray</span>&nbsp;()
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;0&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">result</span>.<span style="font-weight:bold;color:#74531f;">Add</span>&nbsp;{&nbsp;Revenue&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">i</span>];&nbsp;Size&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">result</span>&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">ofSeq</span></pre>
    </p>
    <p>
        The type of <code>cut</code> is now <code>int array -&gt; Cut list</code>. Notice that I decided to return a linked list rather than an array. This is mostly because I consider linked lists to be more idiomatic than arrays in a context of functional programming (FP), but to be honest, I'm not sure that it makes much difference as a return value.
    </p>
    <p>
        In any case, you'll observe that the implementation is still imperative. The main topic of this article is how to give an API good encapsulation, so I treat the actual code as an implementation detail. It's not the most important thing.
    </p>
    <h3 id="8dca0872ab584d0ebefc10200877adde">
        Linked list input <a href="#8dca0872ab584d0ebefc10200877adde">#</a>
    </h3>
    <p>
        Although I wrote that I'm not sure it makes much difference whether <code>cut</code> returns an array or a list, it does matter when it comes to input values. Currently, <code>cut</code> takes an <code>int array</code> as input.
    </p>
    <p>
        As the implementation so amply demonstrates, F# arrays are mutable; you can mutate the cells of an array. A client developer may worry, then, whether <code>cut</code> modifies the input array.
    </p>
    <p>
        From the implementation code we know that it doesn't, but encapsulation is all about sparing client developers the burden of having to read the implementation. Rather, an API should communicate its contract in as succinct a way as possible, either via documentation or the type system.
    </p>
    <p>
        In this case, we can use the type system to communicate this postcondition. Changing the input type to a linked list effectively communicates to all users of the API that <code>cut</code> doesn't mutate the input. This is because F# linked lists are truly immutable.
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">cut</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">ofList</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>.Length&nbsp;-&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[0]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;0
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:blue;">mutable</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Int32</span>.MinValue
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;&lt;&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;<span style="color:blue;">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a08000;">q</span>&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="color:#a08000;">q</span>
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">result</span>&nbsp;=&nbsp;<span style="color:#2b91af;">ResizeArray</span>&nbsp;()
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;0&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">result</span>.<span style="font-weight:bold;color:#74531f;">Add</span>&nbsp;{&nbsp;Revenue&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">i</span>];&nbsp;Size&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">result</span>&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">ofSeq</span></pre>
    </p>
    <p>
        The type of the <code>cut</code> function is now <code>int list -&gt; Cut list</code>, which informs client developers of an invariant. You can trust that <code>cut</code> will not change the input arguments.
    </p>
    <h3 id="fe67c3b6121e4be780bc3d7f3b166a00">
        Natural numbers <a href="#fe67c3b6121e4be780bc3d7f3b166a00">#</a>
    </h3>
    <p>
        You've probably gotten the point by now, so let's move a bit quicker. There are still issues that we'd like to document. Perhaps the worst part of the current API is that client code is required to supply a <code>prices</code> list where the first element <em>must</em> be zero. That's a very specific requirement. It's easy to forget, and if you do, the <code>cut</code> function just silently fails. It doesn't throw an exception; it just gives you a wrong answer.
    </p>
    <p>
        We may choose to add a Guard Clause, but why are we even putting that responsibility on the client developer? Why can't the <code>cut</code> function add that prefix itself? It can, and it turns out that once you do that, and also remove the initial zero element from the output, you're now working with natural numbers.
    </p>
    <p>
        First, add a <code>NaturalNumber</code> wrapper of integers:
    </p>
    <p>
        <pre>type&nbsp;<span style="color:#2b91af;">NaturalNumber</span>&nbsp;=&nbsp;private&nbsp;<span style="color:#2b91af;">NaturalNumber</span>&nbsp;of&nbsp;<span style="color:#2b91af;">int</span>&nbsp;with
&nbsp;&nbsp;&nbsp;&nbsp;member&nbsp;<span style="font-weight:bold;color:#1f377f;">this</span>.Value&nbsp;=&nbsp;let&nbsp;(<span style="color:#2b91af;">NaturalNumber</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>)&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">this</span>&nbsp;in&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>
&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;member&nbsp;<span style="font-weight:bold;color:#74531f;">tryCreate</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">candidate</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;<span style="font-weight:bold;color:#1f377f;">candidate</span>&nbsp;&lt;&nbsp;1&nbsp;then&nbsp;<span style="color:#2b91af;">None</span>&nbsp;else&nbsp;<span style="color:#2b91af;">Some</span>&nbsp;&lt;|&nbsp;<span style="color:#2b91af;">NaturalNumber</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">candidate</span>
&nbsp;&nbsp;&nbsp;&nbsp;override&nbsp;<span style="font-weight:bold;color:#1f377f;">this</span>.<span style="font-weight:bold;color:#74531f;">ToString</span>&nbsp;()&nbsp;=&nbsp;let&nbsp;(<span style="color:#2b91af;">NaturalNumber</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>)&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">this</span>&nbsp;in&nbsp;<span style="color:#74531f;">string</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span></pre>
    </p>
    <p>
        Since the case constructor is <code>private</code>, external code can only <em>try</em> to create values. Once you have a <code>NaturalNumber</code> value, you know that it's valid, but creation requires a run-time check. In other words, this is what Hillel Wayne calls <a href="https://www.hillelwayne.com/post/constructive/">predicative data</a>.
    </p>
    <p>
        Armed with this new type, however, we can now strengthen the definition of the <code>Cut</code> record type:
    </p>
    <p>
        <pre><span style="color:blue;">type</span>&nbsp;<span style="color:#2b91af;">Cut</span>&nbsp;=&nbsp;{&nbsp;Revenue&nbsp;:&nbsp;<span style="color:#2b91af;">int</span>;&nbsp;Size&nbsp;:&nbsp;<span style="color:#2b91af;">NaturalNumber</span>&nbsp;}&nbsp;<span style="color:blue;">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">member</span>&nbsp;<span style="font-weight:bold;color:#74531f;">tryCreate</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">revenue</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">size</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">NaturalNumber</span>.<span style="font-weight:bold;color:#74531f;">tryCreate</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">size</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">Option</span>.<span style="color:#74531f;">map</span>&nbsp;(<span style="color:blue;">fun</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">size</span>&nbsp;<span style="color:blue;">-&gt;</span>&nbsp;{&nbsp;Revenue&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">revenue</span>;&nbsp;Size&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">size</span>&nbsp;})</pre>
    </p>
    <p>
        The <code>Revenue</code> may still be any integer, because it turns out that the algorithm also works with negative prices. (For a book that's very meticulous in its analysis of algorithms, <a href="/ref/clrs">CLRS</a> is surprisingly silent on this topic. Thorough testing with <a href="https://github.com/hedgehogqa/fsharp-hedgehog">Hedgehog</a>, however, indicates that this is so.) On the other hand, the <code>Size</code> of the <code>Cut</code> must be a <code>NaturalNumber</code>. Since, again, we don't have any constructive way (outside of using <a href="https://en.wikipedia.org/wiki/Refinement_type">refinement types</a>) of modelling this requirement, we also supply a <code>tryCreate</code> function.
    </p>
    <p>
        This enables us to define the <code>cut</code> function like this:
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">cut</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">append</span>&nbsp;[0]&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">ofList</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>.Length&nbsp;-&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">zeroCreate</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;+&nbsp;1)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[0]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;0
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:blue;">mutable</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;=&nbsp;<span style="color:#2b91af;">Int32</span>.MinValue
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;<span style="color:#a08000;">q</span>&nbsp;&lt;&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;<span style="color:blue;">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a08000;">q</span>&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">j</span>]&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="color:#a08000;">q</span>
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">result</span>&nbsp;=&nbsp;<span style="color:#2b91af;">ResizeArray</span>&nbsp;()
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;1&nbsp;<span style="color:blue;">to</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Cut</span>.<span style="font-weight:bold;color:#74531f;">tryCreate</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">Option</span>.<span style="color:#74531f;">iter</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">result</span>.<span style="font-weight:bold;color:#74531f;">Add</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">result</span>&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">ofSeq</span></pre>
    </p>
    <p>
        It still has the type <code>int list -&gt; Cut list</code>, but the <code>Cut</code> type is now more restrictively designed. In other words, we've provided a more conservative definition of what we return, in keeping with <a href="https://en.wikipedia.org/wiki/Robustness_principle">Postel's law</a>.
    </p>
    <p>
        Furthermore, notice that the first line prepends <code>0</code> to the <code>p</code> array, so that the client developer doesn't have to do that. Likewise, when returning the result, the <code>for</code> loop goes from <code>1</code> to <code>n</code>, which means that it omits the first zero cut.
    </p>
    <p>
        These changes ripple through and also improves encapsulation of the <code>solve</code> function:
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">solve</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>&nbsp;=&nbsp;<span style="color:#74531f;">cut</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">l</span>&nbsp;=&nbsp;<span style="color:#2b91af;">ResizeArray</span>&nbsp;()
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:blue;">mutable</span>&nbsp;<span style="color:#a08000;">n</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>.Length
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">while</span>&nbsp;<span style="color:#a08000;">n</span>&nbsp;&gt;&nbsp;0&nbsp;<span style="color:blue;">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">idx</span>&nbsp;=&nbsp;<span style="color:#a08000;">n</span>&nbsp;-&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>.[<span style="font-weight:bold;color:#1f377f;">idx</span>].Size
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">l</span>.<span style="font-weight:bold;color:#74531f;">Add</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a08000;">n</span>&nbsp;<span style="color:blue;">&lt;-</span>&nbsp;<span style="color:#a08000;">n</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>.Value
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">l</span>&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">ofSeq</span></pre>
    </p>
    <p>
        The type of <code>solve</code> is now <code>int list -&gt; NaturalNumber list</code>.
    </p>
    <p>
        This is about as strong as I can think of making the API using F#'s type system. A type like <code>int list -&gt; NaturalNumber list</code> tells you something about what you're allowed to do, what you're expected to do, and what you can expect in return. You can provide (almost) any list of integers, both positive, zero, or negative. You may also give an empty list. If we had wanted to prevent that, we could have used a <code>NonEmpty</code> list, as seen (among other places) in the article <a href="/2024/05/06/conservative-codomain-conjecture">Conservative codomain conjecture</a>.
    </p>
    <p>
        Okay, to be perfectly honest, there's one more change that might be in order, but this is where I ran out of steam.  One remaining precondition that I haven't yet discussed is that the input list must not contain 'too big' numbers. The problem is that the algorithm adds numbers together, and since 32-bit integers are bounded, you could run into overflow situations. Ask me how I know.
    </p>
    <p>
        Changing the types to use 64-bit integers doesn't solve that problem (it only moves the boundary of where overflow happens), but consistently changing the API to work with <a href="https://learn.microsoft.com/dotnet/api/system.numerics.biginteger">BigInteger</a> values might. To be honest, I haven't tried.
    </p>
    <h3 id="641bc16e730542a1a4a231886d208f24">
        Functional programming <a href="#641bc16e730542a1a4a231886d208f24">#</a>
    </h3>
    <p>
        From an encapsulation perspective, we're done now. By using the type system, we've emphasized how to <em>use</em> the API, rather than how it's implemented. Along the way, we even hid away some warts that came with the implementation. If I wanted to take this further, I would seriously consider making the <code>cut</code> function a <code>private</code> helper function, because it doesn't really return a solution. It only returns an intermediary value that makes it easier for the <code>solve</code> function to return the actual solution.
    </p>
    <p>
        If you're even just a little bit familiar with F# or functional programming, you may have found it painful to read this far. <em>All that imperative code. My eyes! For the love of God, please rewrite the implementation with proper FP idioms and patterns.</em>
    </p>
    <p>
        Well, the point of the whole article is that the implementation doesn't really matter. It's how client code may <em>use</em> the API that's important.
    </p>
    <p>
        That is, of course, until you have to go and change the implementation code. In any case, as a little consolation prize for those brave FP readers who've made it all this way, here follows more functional implementations of the functions.
    </p>
    <p>
        The <code>NaturalNumber</code> and <code>Cut</code> types haven't changed, so the first change comes with the <code>cut</code> function:
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:#74531f;">cons</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">x</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">xs</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">x</span>&nbsp;<span style="color:#2b91af;">::</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">xs</span>
 
<span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">cut</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>&nbsp;=&nbsp;0&nbsp;<span style="color:#2b91af;">::</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">Array</span>.<span style="color:#74531f;">ofList</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>.Length&nbsp;-&nbsp;1
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">findBestCut</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">revenues</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1..<span style="font-weight:bold;color:#1f377f;">j</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">map</span>&nbsp;(<span style="color:blue;">fun</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;<span style="color:blue;">-&gt;</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">p</span>[<span style="font-weight:bold;color:#1f377f;">i</span>]&nbsp;+&nbsp;<span style="color:#2b91af;">Map</span>.<span style="color:#74531f;">find</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>)&nbsp;<span style="font-weight:bold;color:#1f377f;">revenues</span>,&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">maxBy</span>&nbsp;<span style="color:#74531f;">fst</span>
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">aggregate</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">acc</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">revenues</span>&nbsp;=&nbsp;<span style="color:#74531f;">snd</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">acc</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">q</span>,&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>&nbsp;=&nbsp;<span style="color:#74531f;">findBestCut</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">revenues</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">j</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">cuts</span>&nbsp;=&nbsp;<span style="color:#74531f;">fst</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">acc</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#74531f;">cuts</span>&nbsp;&lt;&lt;&nbsp;(<span style="color:#74531f;">cons</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">q</span>,&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>)),&nbsp;<span style="color:#2b91af;">Map</span>.<span style="color:#74531f;">add</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">revenues</span>.Count&nbsp;<span style="font-weight:bold;color:#1f377f;">q</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">revenues</span>
 
&nbsp;&nbsp;&nbsp;&nbsp;[1..<span style="font-weight:bold;color:#1f377f;">n</span>]
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">fold</span>&nbsp;<span style="color:#74531f;">aggregate</span>&nbsp;(<span style="color:#74531f;">id</span>,&nbsp;<span style="color:#2b91af;">Map</span>.<span style="color:#74531f;">add</span>&nbsp;0&nbsp;0&nbsp;<span style="color:#2b91af;">Map</span>.empty)
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style="color:#74531f;">fst</span>&nbsp;&lt;|&nbsp;[]&nbsp;<span style="color:green;">//&nbsp;Evaluate&nbsp;Hughes&nbsp;list</span>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">List</span>.<span style="color:#74531f;">choose</span>&nbsp;(<span style="color:blue;">fun</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">r</span>,&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>)&nbsp;<span style="color:blue;">-&gt;</span>&nbsp;<span style="color:#2b91af;">Cut</span>.<span style="font-weight:bold;color:#74531f;">tryCreate</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">r</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">i</span>)</pre>
    </p>
    <p>
        Even here, however, some implementation choices are dubious at best. For instance, I decided to use a Hughes list or difference list (see <a href="/2015/12/22/tail-recurse">Tail Recurse</a> for a detailed explanation of how this works in F#) without measuring whether or not it was better than just using normal <em>list consing</em> followed by <code>List.rev</code> (which is, in fact, often faster). That's one of the advantages of writing code for articles; such things don't really matter that much in that context.
    </p>
    <p>
        Another choice that may leave you scratching your head is that I decided to model the <code>revenues</code> as a map (that is, an immutable dictionary) rather than an array. I did this because I was concerned that with the move towards immutable code, I'd have <code>n</code> reallocations of arrays. Perhaps, I thought, adding incrementally to a <code>Map</code> structure would be more efficient.
    </p>
    <p>
        But really, all of that is just wanking, because I haven't measured.
    </p>
    <p>
        The FP-style implementation of <code>solve</code> is, I believe, less controversial:
    </p>
    <p>
        <pre><span style="color:blue;">let</span>&nbsp;<span style="color:#74531f;">solve</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>&nbsp;=&nbsp;<span style="color:#74531f;">cut</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="color:blue;">rec</span>&nbsp;<span style="color:#74531f;">imp</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;&lt;=&nbsp;0&nbsp;<span style="color:blue;">then</span>&nbsp;[]&nbsp;<span style="color:blue;">else</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">idx</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;-&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;=&nbsp;<span style="font-weight:bold;color:#1f377f;">cuts</span>[<span style="font-weight:bold;color:#1f377f;">idx</span>].Size
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>&nbsp;<span style="color:#2b91af;">::</span>&nbsp;<span style="color:#74531f;">imp</span>&nbsp;(<span style="font-weight:bold;color:#1f377f;">n</span>&nbsp;-&nbsp;<span style="font-weight:bold;color:#1f377f;">s</span>.Value)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#74531f;">imp</span>&nbsp;<span style="font-weight:bold;color:#1f377f;">prices</span>.Length</pre>
    </p>
    <p>
        This is a fairly standard implementation using a local recursive helper function.
    </p>
    <p>
        Both <code>cut</code> and <code>solve</code> have the types previously reported. In other words, this final refactoring to functional implementations didn't change their types.
    </p>
    <h3 id="c009b6e42470466c9556f52a7c5af175">
        Conclusion <a href="#c009b6e42470466c9556f52a7c5af175">#</a>
    </h3>
    <p>
        This article goes through a series of code improvements to illustrate how a static type system can make it easier to use an API. Use it <em>correctly</em>, that is.
    </p>
    <p>
        There's a common misconception about ease of use that it implies typing fewer characters, or getting instant <a href="/2024/05/13/gratification">gratification</a>. That's not my position. <a href="/2018/09/17/typing-is-not-a-programming-bottleneck">Typing is not a bottleneck</a>, and in any case, not much is gained if you make it easier for client developers to get the wrong answers from your API.
    </p>
    <p>
        Static types gives you a consistent vocabulary you can use to communicate an API's contract to client developers. What must client code do in order to make a valid method or function call? What guarantees can client code rely on? <a href="/encapsulation-and-solid">Encapsulation</a>, in other words.
    </p>
    <ins datetime="2025-01-20">
        <p>
            <strong>P.S. 2025-01-20:</strong>
        </p>
        <p>
            For a type-level technique for modelling the relationship between rod size and price list, see <a href="/2025/01/20/modelling-data-relationships-with-f-types">Modelling data relationships with F# types</a>.
        </p>
    </ins>
</div>
